name: Conn3ction Prototype CI

on:
  push:
    paths:
      - 'prototype/api/**'
      - '.github/workflows/prototype-ci.yml'
  pull_request:
    paths:
      - 'prototype/api/**'
      - '.github/workflows/prototype-ci.yml'

permissions:
  contents: read

jobs:
  build-and-test:
    name: Build and Test API
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
    
    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('prototype/api/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-
    
    - name: Download dependencies
      working-directory: ./prototype/api
      run: go mod download
    
    - name: Run go vet
      working-directory: ./prototype/api
      run: go vet ./...
    
    - name: Run go fmt check
      working-directory: ./prototype/api
      run: |
        if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
          echo "The following files need formatting:"
          gofmt -s -l .
          exit 1
        fi
    
    - name: Build
      working-directory: ./prototype/api
      run: go build -v .
    
    - name: Run tests
      working-directory: ./prototype/api
      run: go test -v -race -coverprofile=coverage.txt -covermode=atomic ./...
    
    - name: Upload coverage
      uses: codecov/codecov-action@v4
      with:
        files: ./prototype/api/coverage.txt
        flags: api
        fail_ci_if_error: false
  
  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build Docker image
      working-directory: ./prototype/api
      run: docker build -t conn3ction-api:${{ github.sha }} .
    
    - name: Test Docker image
      run: |
        docker run -d --name test-api -p 8080:8080 conn3ction-api:${{ github.sha }}
        sleep 5
        curl -f http://localhost:8080/healthz || exit 1
        docker stop test-api
        docker rm test-api
  
  helm-lint:
    name: Helm Lint
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Helm
      uses: azure/setup-helm@v4
      with:
        version: '3.13.0'
    
    - name: Lint API Helm chart
      run: helm lint ./prototype/charts/api
    
    - name: Lint CoreDNS-etcd Helm chart
      run: helm lint ./prototype/charts/coredns-etcd
    
    - name: Template API chart
      run: helm template test ./prototype/charts/api
    
    - name: Template CoreDNS-etcd chart
      run: helm template test ./prototype/charts/coredns-etcd
